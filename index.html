<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LTR Daily Status</title>
  <style>
    :root{
      --bg:#f3f6fa;
      --orange:#e67e22;
      --header:#2c3e50;
      --thead:#ddd;
      --equip:#fff8c6;
      --st-c:#6a0dad; /* ungu tua */
      --st-ip:#1f77b4; /* biru */
      --dev-neg:#c0392b;
      --date-green:#116530; /* hijau tua */
      --border:#ccc;
    }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:#222;
    }
    header{
      background:var(--header);
      color:#fff;
      padding:12px 16px;
      font-weight:700;
      text-align:center;
    }
    nav{
      display:flex;
      gap:8px;
      padding:8px 16px;
      background:#fff;
      border-bottom:1px solid #eee;
    }
    .tab-btn{
      padding:6px 12px;
      background:#f0f0f0;
      border:1px solid #ddd;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    .tab-btn.active{ background:var(--orange); color:#fff; border-color:transparent; }

    .container{ padding:14px 16px; }

    .category-wrap{
      margin-bottom:16px;
      border-radius:8px;
      box-shadow:0 6px 12px rgba(0,0,0,0.06);
      overflow:hidden;
      background:#fff;
    }
    .category{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      background:var(--orange);
      color:#fff;
      font-weight:600;
      font-size:14px;
    }
    .cat-controls button{
      background: rgba(255,255,255,0.18);
      border:none;
      color:#fff;
      padding:4px 8px;
      margin-left:6px;
      border-radius:4px;
      cursor:pointer;
      font-weight:700;
    }

    .table-wrap{ padding:6px; background:#fff; border-top:1px solid var(--border); }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:12px;
    }
    thead th{
      background:var(--thead);
      border:1px solid var(--border);
      padding:3px 4px;         /* diperkecil */
      font-weight:400;
      font-size:11px;
      position:sticky;
      top:0;
      z-index:2;
    }
    tbody td{
      border:1px solid var(--border);
      padding:2px 4px;         /* diperkecil */
      vertical-align:middle;
      height:22px;             /* lebih ramping */
      overflow:hidden;
      font-size:13px;
      text-align:center;
    }

    /* columns */
    .c-no{ width:36px; min-width:36px; }
    .c-equip{ width:90px; min-width:70px; text-align:left; padding-left:6px; }
    .c-status{ width:80px; min-width:70px; }
    .c-desc{ width:160px; min-width:120px; text-align:left; padding-left:6px; }
    .c-progress{ width:200px; min-width:140px; text-align:left; padding-left:6px; }
    .c-small{ width:56px; min-width:46px; }
    .c-dt{ width:110px; min-width:100px; } /* diperkecil */
    .c-num{ width:64px; min-width:54px; }
    .c-action{ width:60px; min-width:50px; }

    tr.equip-row{ background:var(--equip); }
    tr.sub-row{ background:#fff; }

    /* contenteditable styling (no box) */
    td[contenteditable="true"]{ outline:none; cursor:text; }
    td[contenteditable="true"]::placeholder{ color:#999; }

    /* small action buttons */
    .icon-btn{
      border:none;
      background:#e6e6e6;
      padding:4px 6px;
      border-radius:4px;
      cursor:pointer;
      margin-left:4px;
      font-weight:700;
    }
    .icon-del{ background:#f2b8b8; }
    .icon-add{ background:#c8e6c9; }

    /* status colors */
    .st-c{ background:var(--st-c) !important; color:#fff !important; font-weight:700; }
    .st-ip{ background:var(--st-ip) !important; color:#fff !important; font-weight:700; }

    .dev-negative{ background:var(--dev-neg); color:#fff; }

    /* d-part filled */
    .filled{ background:#fff8c6; }

    /* date green */
    .date-green{ background:var(--date-green); color:#fff; font-weight:700; }

    /* export buttons */
    .controls{ display:flex; gap:8px; margin-bottom:12px; }
    .controls button{ padding:8px 10px; border-radius:6px; border:none; cursor:pointer; background:#3498db; color:#fff; }

    /* print adjustments */
    @page { size: A4 landscape; margin: 6mm; }
    @media print {
      body { background: #fff; -webkit-print-color-adjust: exact; }
      nav, .controls, .icon-btn, .cat-controls { display: none !important; }
      table { page-break-inside: auto; width:100%; }
      thead { display:table-header-group; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      td, th { padding: 2px 4px; font-size:10px; }
    }

    /* responsive */
    @media (max-width:900px){
      .c-desc, .c-progress{ width:120px; }
      .c-dt{ width:100px; }
    }
  </style>
</head>
<body>
  <header>LTR Daily Status</header>

  <nav>
    <button class="tab-btn active" data-tab="daily">1. Daily LTR</button>
    <button class="tab-btn" data-tab="summary">2. Summary LTR</button>
  </nav>

  <div class="container">
    <div class="controls">
      <button id="btnAddCategory">+ Add Category</button>
      <button id="btnExportExcel">Download Excel</button>
      <button id="btnExportPDF">Download PDF</button>
    </div>

    <!-- categories list -->
    <div id="categoriesList"></div>

    <!-- summary placeholder -->
    <div id="summary" style="display:none;">
      <h3>Summary LTR</h3>
      <p>Coming soon...</p>
    </div>
  </div>

<!-- Firebase SDK -->
<!-- Firebase Input & Save -->
<div style="margin-bottom:12px; padding:8px; background:#fff; border-radius:6px; box-shadow:0 4px 8px rgba(0,0,0,0.05);">
  <button id="saveBtn" style="padding:6px 10px; border:none; border-radius:4px; background:var(--orange); color:#fff; cursor:pointer;">Save All to Firebase</button>
</div>

<script type="module">
  // Import Firebase modul yang tersedia
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11/firebase-analytics.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11/firebase-firestore.js";

  // Konfigurasi Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCET8kx3EUAghmu6ctKUoiVY1RN2MIXv_s",
    authDomain: "daily-ltr.firebaseapp.com",
    projectId: "daily-ltr",
    storageBucket: "daily-ltr.firebasestorage.app",
    messagingSenderId: "227395041351",
    appId: "1:227395041351:web:b3deaab08be421bb3bd962",
    measurementId: "G-VXF6HH5FDW"
  };

  // Inisialisasi Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // ------------------ REVISI BAGIAN SAVE ------------------
  async function saveAllData() {
    try {
      const categories = [];
      const allCats = document.querySelectorAll('.category-wrap');

      allCats.forEach(cat => {
        const catName = cat.querySelector('.cat-title')?.textContent.trim() || "Unnamed Category";
        const equips = [];
        const equipRows = cat.querySelectorAll('tr.equip-row');

        equipRows.forEach(equip => {
          const cells = equip.children;
          const equipObj = {
            name: cells[1]?.textContent.trim() || "Unnamed Equip",
            status: cells[2]?.textContent.trim() || "",
            description: cells[3]?.textContent.trim() || "",
            progress: cells[4]?.textContent.trim() || "",
            st: cells[5]?.textContent.trim() || "",
            delay: cells[6]?.textContent.trim() || "",
            pic: cells[7]?.textContent.trim() || "",
            down: cells[8]?.querySelector('input')?.value || "",
            up: cells[9]?.querySelector('input')?.value || "",
            plan: cells[10]?.textContent.trim() || "",
            actual: cells[11]?.textContent.trim() || "",
            dev: cells[12]?.textContent.trim() || "",
            pct: cells[13]?.textContent.trim() || "",
            dates: Array.from(equip.querySelectorAll('td.date-col')).map(d => d.textContent.trim() || ""),
            part: cells[cells.length-5]?.textContent.trim() || "",
            sup: cells[cells.length-4]?.textContent.trim() || "",
            lab: cells[cells.length-3]?.textContent.trim() || "",
            weat: cells[cells.length-2]?.textContent.trim() || "",
            sub: []
          };

          // Ambil sub-row yang terkait
          let sub = equip.nextElementSibling;
          while(sub && sub.classList.contains('sub-row') && sub.dataset.parent === equip.dataset.equipId){
            const sc = sub.children;
            const subObj = {
              st: sc[5]?.textContent.trim() || "",
              part: sc[sc.length-5]?.textContent.trim() || "",
              sup: sc[sc.length-4]?.textContent.trim() || "",
              lab: sc[sc.length-3]?.textContent.trim() || "",
              weat: sc[sc.length-2]?.textContent.trim() || ""
            };
            equipObj.sub.push(subObj);
            sub = sub.nextElementSibling;
          }

          equips.push(equipObj);
        });

        categories.push({ name: catName, equips });
      });

      if(categories.length===0){ 
        alert("Tidak ada data untuk disimpan"); 
        return; 
      }

      const docRef = await addDoc(collection(db, "daily-ltr"), {
        timestamp: new Date().toISOString(),
        categories
      });

      console.log("Document written with ID: ", docRef.id);
      alert("Semua data berhasil disimpan ke Firebase!");
    } catch(e) {
      console.error("Error adding document: ", e);
      alert("Gagal menyimpan data! Lihat console untuk detail error.");
    }
  }

  // Pasang listener tombol Save
  document.getElementById("saveBtn").addEventListener("click", saveAllData);
</script>
  <script>

  // TAB
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const t = b.dataset.tab;
      if(t==='daily'){ document.getElementById('categoriesList').style.display='block'; document.getElementById('summary').style.display='none'; }
      else { document.getElementById('categoriesList').style.display='none'; document.getElementById('summary').style.display='block'; }
    });
  });

  // Date columns dynamic (today -1 .. +6)
  function getDateCols(){
    const arr=[]; let today=new Date(); today.setDate(today.getDate()-1);
    for(let i=0;i<8;i++){ const d=new Date(today); d.setDate(today.getDate()+i); arr.push({obj:d,label:String(d.getDate())}); }
    return arr;
  }
  const DATE_COLS = getDateCols();

  // IDs
  let catIdCounter = 0;

  document.getElementById('btnAddCategory').addEventListener('click', ()=>addCategory());
  document.getElementById('btnExportExcel').addEventListener('click', ()=>exportAllTablesToExcel());
  document.getElementById('btnExportPDF').addEventListener('click', ()=>window.print());

  function addCategory(){
    const title = prompt('Masukkan nama Category (contoh: Loading - Sitarum):', 'Loading - Sitarum');
    if(!title) return;
    catIdCounter++;
    const cid = 'cat-'+catIdCounter;
    const wrap = document.createElement('div'); wrap.className='category-wrap'; wrap.id = cid;

    // header
    const header = document.createElement('div'); header.className='category';
    header.innerHTML = `<div class="cat-title">${escapeHtml(title)}</div>
                        <div class="cat-controls">
                          <button onclick="renameCategory('${cid}')">R</button>
                          <button onclick="deleteCategory('${cid}')">D</button>
                        </div>`;
    wrap.appendChild(header);

    // table
    const tw = document.createElement('div'); tw.className='table-wrap';
    const table = document.createElement('table');
    table.id = cid + '-table';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    const headers = [
      {k:'no',label:'No',cls:'c-no'},
      {k:'equip',label:'Equip',cls:'c-equip'},
      {k:'status',label:'Status',cls:'c-status'},
      {k:'description',label:'Description',cls:'c-desc'},
      {k:'progress',label:'Progress',cls:'c-progress'},
      {k:'st',label:'St',cls:'c-small'},
      {k:'delay',label:'Delay',cls:'c-small'},
      {k:'pic',label:'PIC',cls:'c-small'},
      {k:'down',label:'Down Time',cls:'c-dt'},
      {k:'up',label:'Uptime',cls:'c-dt'},
      {k:'plan',label:'Plan',cls:'c-num'},
      {k:'actual',label:'Actual',cls:'c-num'},
      {k:'dev',label:'Dev',cls:'c-num'},
      {k:'pct',label:'%',cls:'c-num'},
    ];
    headers.forEach(h=>{ const th=document.createElement('th'); if(h.cls) th.className=h.cls; th.textContent=h.label; trh.appendChild(th); });

    // date cols
    DATE_COLS.forEach(dc=>{ const th=document.createElement('th'); th.textContent = dc.label; trh.appendChild(th); });

    // Part..Weat + Action (rename labels here)
    ['Part','Sup','Lab','Weat','Action'].forEach(lbl=>{ const th=document.createElement('th'); th.textContent = lbl; if(lbl==='Action') th.className='c-action'; trh.appendChild(th); });

    thead.appendChild(trh); table.appendChild(thead);

    const tbody = document.createElement('tbody'); tbody.id = cid + '-tbody'; table.appendChild(tbody);
    tw.appendChild(table);
    wrap.appendChild(tw);

    // add new button (below)
    const addWrap = document.createElement('div'); addWrap.style.padding='8px';
    const addBtn = document.createElement('button'); addBtn.textContent = '+ Add New (Equip)'; addBtn.className = 'icon-btn';
    addBtn.onclick = ()=> addEquip(tbody, cid);
    addWrap.appendChild(addBtn);
    wrap.appendChild(addWrap);

    document.getElementById('categoriesList').appendChild(wrap);
    wrap.dataset.nextEquip = '1';
  }

  function renameCategory(cid){
    const wrap = document.getElementById(cid);
    const cur = wrap.querySelector('.cat-title').textContent;
    const n = prompt('Rename category:', cur);
    if(n) wrap.querySelector('.cat-title').textContent = n;
  }
  function deleteCategory(cid){
    if(!confirm('Hapus category?')) return;
    document.getElementById(cid).remove();
  }

  function addEquip(tbody, cid){
    const wrap = document.getElementById(cid);
    let next = parseInt(wrap.dataset.nextEquip || '1',10);
    const equipId = cid + '-equip-' + next;
    wrap.dataset.nextEquip = String(next+1);

    const tr = document.createElement('tr'); tr.className='equip-row'; tr.dataset.equipId = equipId;

    const tdNo = document.createElement('td'); tdNo.className='c-no';
    tdNo.textContent = '';
    tdNo.style.cursor = 'pointer';
    tdNo.addEventListener('click', ()=> toggleSub(equipId, tdNo));
    tr.appendChild(tdNo);

    const names = ['equip','status','description','progress'];
    for(let i=0;i<4;i++){
      const td=document.createElement('td'); td.contentEditable = 'true';
      if(names[i]==='description' || names[i]==='progress') td.style.textAlign='left';
      tr.appendChild(td);
    }

    ['st','delay','pic'].forEach(k=>{
      const td=document.createElement('td'); td.contentEditable='true'; td.className='c-small'; td.style.textAlign='center';
      td.addEventListener('input', ()=> onStChange(tr)); // optional
      tr.appendChild(td);
    });

    const tdDown = document.createElement('td'); tdDown.className='c-dt';
    const inDown = document.createElement('input'); inDown.type='datetime-local';
    inDown.style.border='none'; inDown.style.background='transparent'; inDown.style.width='100%';
    inDown.addEventListener('change', ()=> recalcRow(tr));
    tdDown.appendChild(inDown); tr.appendChild(tdDown);

    const tdUp = document.createElement('td'); tdUp.className='c-dt';
    const inUp = document.createElement('input'); inUp.type='datetime-local';
    inUp.style.border='none'; inUp.style.background='transparent'; inUp.style.width='100%';
    inUp.addEventListener('change', ()=> recalcRow(tr));
    tdUp.appendChild(inUp); tr.appendChild(tdUp);

    const tdPlan = document.createElement('td'); tdPlan.contentEditable='true'; tdPlan.className='c-num';
    tdPlan.addEventListener('input', ()=> recalcRow(tr));
    tr.appendChild(tdPlan);

    const tdActual = document.createElement('td'); tdActual.className='actual c-num'; tdActual.textContent='0'; tr.appendChild(tdActual);
    const tdDev = document.createElement('td'); tdDev.className='dev c-num'; tdDev.textContent='0'; tr.appendChild(tdDev);
    const tdPct = document.createElement('td'); tdPct.className='pct c-num'; tdPct.textContent='0%'; tr.appendChild(tdPct);

    for(let i=0;i<DATE_COLS.length;i++){ const td=document.createElement('td'); td.className='date-col'; td.textContent=''; tr.appendChild(td); }

    // Part..Weat (editable + total)
    ['Part','Sup','Lab','Weat'].forEach(n=>{
      const td=document.createElement('td'); td.contentEditable='true';
      td.addEventListener('input', ()=>{
        td.classList.toggle('filled', td.innerText.trim() !== '');
        recomputeTotalsForEquip(tr); // tambahan total otomatis
      });
      tr.appendChild(td);
    });

    const tdAction = document.createElement('td'); tdAction.className='c-action';
    const addBtn = document.createElement('button'); addBtn.textContent = '+'; addBtn.className='icon-btn icon-add';
    addBtn.addEventListener('click', ()=> addSub(equipId, tr));
    const delBtn = document.createElement('button'); delBtn.textContent = '-'; delBtn.className='icon-btn icon-del';
    delBtn.addEventListener('click', ()=> { if(confirm('Hapus equip?')) { removeSubs(equipId, tbody); tr.remove(); refreshNumbers(tbody, cid); }});
    tdAction.appendChild(addBtn); tdAction.appendChild(delBtn); tr.appendChild(tdAction);

    tbody.appendChild(tr);
    refreshNumbers(tbody, cid);
  }

  function addSub(equipId, equipRow){
    const tbody = equipRow.parentElement;
    const trSub = document.createElement('tr'); trSub.className='sub-row'; trSub.dataset.parent = equipId;

    const cols = equipRow.children.length;
    for(let i=0;i<cols;i++){
      const td = document.createElement('td');
      const lastIndex = cols - 1;
      const dpartStart = lastIndex - 4;
      if(i===4 || i===5 || i===6 || i===7){
        td.contentEditable='true';
        if(i===4){ td.style.textAlign='left'; }
        if(i===5){
          td.addEventListener('input', ()=>{
            const v = (td.innerText||'').trim().toUpperCase();
            td.classList.remove('st-c','st-ip');
            if(v==='C') td.classList.add('st-c');
            else if(v==='IP') td.classList.add('st-ip');
            recomputePercentForEquip(equipRow);
          });
        }
      } else if(i >= dpartStart && i <= dpartStart + 3){
        td.contentEditable='true';
        td.addEventListener('input', ()=>{
          td.classList.toggle('filled', td.innerText.trim() !== '');
          recomputeTotalsForEquip(equipRow);
        });
      } else if(i === cols -1){
        const del = document.createElement('button'); del.textContent='-'; del.className='icon-btn icon-del';
        del.addEventListener('click', ()=> { if(confirm('Hapus sub?')){ trSub.remove(); recomputePercentForEquip(equipRow); recomputeTotalsForEquip(equipRow); }});
        td.appendChild(del);
      }
      trSub.appendChild(td);
    }

    let insertAfter = equipRow;
    let next = equipRow.nextElementSibling;
    while(next && next.classList.contains('sub-row') && next.dataset.parent === equipId){ insertAfter = next; next = next.nextElementSibling; }
    insertAfter.insertAdjacentElement('afterend', trSub);

    recomputePercentForEquip(equipRow);
    recomputeTotalsForEquip(equipRow);
  }

  function removeSubs(equipId, tbody){
    const subs = Array.from(tbody.querySelectorAll('tr.sub-row'));
    subs.forEach(s=> { if(s.dataset.parent===equipId) s.remove(); });
  }

  function refreshNumbers(tbody, cid){
    const rows = Array.from(tbody.querySelectorAll('tr.equip-row'));
    rows.forEach((r,i)=>{ const noCell = r.querySelector('td.c-no'); if(noCell) noCell.textContent = (i+1); else r.children[0].textContent = (i+1); });
    rows.forEach(r=>{ recomputePercentForEquip(r); recomputeTotalsForEquip(r); });
  }

  function toggleSub(equipId, tdNo){
    const tbody = tdNo.closest('tbody');
    const subs = Array.from(tbody.querySelectorAll('tr.sub-row'));
    let any=false;
    for(const s of subs){ if(s.dataset.parent === equipId){ any=true; break; } }
    if(!any) return;
    subs.forEach(s=>{ if(s.dataset.parent === equipId){ s.style.display = (s.style.display === 'none') ? '' : 'none'; }});
  }

  function recomputePercentForEquip(equipRow){
    const tbody = equipRow.parentElement;
    const equipId = equipRow.dataset.equipId;
    let sub = equipRow.nextElementSibling;
    let total = 0, complete = 0;
    const headers = Array.from(equipRow.closest('table').querySelectorAll('thead th')).map(h=>h.textContent.trim());
    const stIndex = headers.indexOf('St');
    while(sub && sub.classList.contains('sub-row')){
      if(sub.dataset.parent === equipId){
        total++;
        const stCell = sub.children[stIndex];
        if(stCell && (stCell.innerText || '').trim().toUpperCase() === 'C') complete++;
      }
      sub = sub.nextElementSibling;
    }
    const pctCell = equipRow.querySelector('.pct');
    if(total>0){ const pct = Math.round((complete/total)*100); if(pctCell) pctCell.textContent = pct + '%'; }
    else { if(pctCell) pctCell.textContent = '0%'; }
  }

  function recomputeTotalsForEquip(equipRow){
    const tbody = equipRow.parentElement;
    const equipId = equipRow.dataset.equipId;
    const headers = Array.from(equipRow.closest('table').querySelectorAll('thead th')).map(h=>h.textContent.trim());
    const partIdx = headers.indexOf('Part');
    const supIdx = headers.indexOf('Sup');
    const labIdx = headers.indexOf('Lab');
    const weatIdx = headers.indexOf('Weat');

    const totals = [0,0,0,0]; // Part, Sup, Lab, Weat
    let sub = equipRow.nextElementSibling;
    while(sub && sub.classList.contains('sub-row')){
      if(sub.dataset.parent === equipId){
        totals[0] += parseFloat(sub.children[partIdx].innerText||0) || 0;
        totals[1] += parseFloat(sub.children[supIdx].innerText||0) || 0;
        totals[2] += parseFloat(sub.children[labIdx].innerText||0) || 0;
        totals[3] += parseFloat(sub.children[weatIdx].innerText||0) || 0;
      }
      sub = sub.nextElementSibling;
    }
    // update equipRow totals
    if(partIdx>=0) equipRow.children[partIdx].textContent = totals[0] || '';
    if(supIdx>=0) equipRow.children[supIdx].textContent = totals[1] || '';
    if(labIdx>=0) equipRow.children[labIdx].textContent = totals[2] || '';
    if(weatIdx>=0) equipRow.children[weatIdx].textContent = totals[3] || '';
  }

  function recalcRow(tr){
    const ths = Array.from(tr.closest('table').querySelectorAll('thead th')).map(h=>h.textContent.trim());
    const downIdx = ths.indexOf('Down Time');
    const upIdx = ths.indexOf('Uptime');
    const planIdx = ths.indexOf('Plan');
    const actualIdx = ths.indexOf('Actual');
    const devIdx = ths.indexOf('Dev');

    const downInput = tr.children[downIdx]?.querySelector('input');
    const upInput = tr.children[upIdx]?.querySelector('input');
    let actual = 0;
    if(downInput && upInput && downInput.value && upInput.value){
      const d = new Date(downInput.value);
      const u = new Date(upInput.value);
      if(!isNaN(d) && !isNaN(u) && u > d) actual = (u - d) / 36e5;
    }
    if(tr.children[actualIdx]) tr.children[actualIdx].textContent = actual ? String(Math.round(actual)) : '0';
    const planVal = parseFloat(tr.children[planIdx].innerText || tr.children[planIdx].textContent || '0') || 0;
    const dev = planVal - actual;
    if(tr.children[devIdx]){
      tr.children[devIdx].textContent = String(Math.round(dev));
      tr.children[devIdx].classList.toggle('dev-negative', dev < 0);
    }
    const upVal = upInput ? upInput.value : null;
    const downVal = downInput ? downInput.value : null;
    markDateRange(tr, upVal, downVal);
  }

  function markDateRange(tr, upVal, downVal){
    const ths = Array.from(tr.closest('table').querySelectorAll('thead th')).map(h=>h.textContent.trim());
    const startIndex = ths.indexOf(DATE_COLS[0].label);
    if(startIndex === -1) return;
    for(let i=0;i<DATE_COLS.length;i++){ const c = tr.children[startIndex + i]; if(c) c.classList.remove('date-green'); }
    if(!upVal || !downVal) return;
    const up = new Date(upVal), down = new Date(downVal);
    if(isNaN(up) || isNaN(down)) return;
    for(let i=0;i<DATE_COLS.length;i++){ const dayNum = DATE_COLS[i].obj.getDate();
      if(dayNum >= 15 && dayNum >= down.getDate() && dayNum <= up.getDate()){
        const cell = tr.children[startIndex + i]; if(cell) cell.classList.add('date-green');
      }
    }
  }

  function exportAllTablesToExcel(){
    const tables = document.querySelectorAll('.table-wrap table');
    if(tables.length===0){ alert('No data to export'); return; }
    let html = '<html><head><meta charset="UTF-8"></head><body>';
    tables.forEach((t, idx)=>{ html += '<h3>' + escapeHtml(t.closest('.category-wrap').querySelector('.cat-title').textContent) + '</h3>'; html += t.outerHTML; html += '<br/>'; });
    html += '</body></html>';
    const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'LTR_Daily_Status.xls'; a.click();
    URL.revokeObjectURL(url);
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }


// --------------------- MENU 2: Summary ---------------------
const summaryDiv = document.getElementById('summary');

document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    if(b.dataset.tab === 'summary'){
      const loadBtn = document.getElementById('btnAddCategory');
      loadBtn.textContent = 'Load Data';
      loadBtn.onclick = loadSummaryData;
    }
  });
});

function loadSummaryData(){
  summaryDiv.innerHTML = ''; // clear dulu
  const allCategories = document.querySelectorAll('.category-wrap');

  allCategories.forEach(cat=>{
    const catName = cat.querySelector('.cat-title').textContent;

    // tabel
    const table = document.createElement('table');
    table.style.marginBottom = '12px';
    table.style.width = '90%'; // perkecil
    table.style.borderCollapse = 'collapse';
    table.style.fontSize = '12px';

    // thead
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['Equip','Plan','Actual','Dev','%','Part','Sup','Lab','Weat','Delay'].forEach(lbl=>{
      const th = document.createElement('th');
      th.textContent = lbl;
      th.style.border = '1px solid var(--border)';
      th.style.padding = '4px';
      th.style.background = 'var(--thead)';
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    // tbody
    const tbody = document.createElement('tbody');

    // Category row (background sama seperti menu 1, selebar tabel)
    const catRow = document.createElement('tr');
    const catTd = document.createElement('td');
    catTd.colSpan = 10; // sampai kolom Delay
    catTd.style.background = 'var(--orange)';
    catTd.style.color = '#fff';
    catTd.style.fontWeight = '600';
    catTd.style.textAlign = 'left';
    catTd.style.paddingLeft = '6px';
    catTd.textContent = catName;
    catRow.appendChild(catTd);
    tbody.appendChild(catRow);

    const equipRows = cat.querySelectorAll('tr.equip-row');
    equipRows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.style.background = 'var(--equip)';

      const plan = parseFloat(r.children[10]?.textContent || 0) || 0;
      const actual = parseFloat(r.children[11]?.textContent || 0) || 0;
      const dev = plan - actual;
      const pct = r.children[13]?.textContent || '0%';

      const part = parseFloat(r.children[r.children.length-5]?.textContent || 0) || 0;
      const sup = parseFloat(r.children[r.children.length-4]?.textContent || 0) || 0;
      const lab = parseFloat(r.children[r.children.length-3]?.textContent || 0) || 0;
      const weat = parseFloat(r.children[r.children.length-2]?.textContent || 0) || 0;
      const delay = part + sup + lab + weat;

      const values = [
        r.children[1]?.textContent || '', // Equip
        plan, actual, dev, pct,
        part, sup, lab, weat, delay
      ];

      values.forEach((v,i)=>{
        const td = document.createElement('td');
        td.textContent = v;
        td.style.border = '1px solid var(--border)';
        td.style.padding = '2px 4px';
        td.style.textAlign = 'center';
        // pewarnaan Dev
        if(i===3 && dev<0){
          td.style.background = 'var(--dev-neg)';
          td.style.color = '#fff';
          td.style.fontWeight = '600';
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    summaryDiv.appendChild(table);
  });
}

  </script>
</body>
</html>

